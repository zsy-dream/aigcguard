# 技术验证说明书 (Technical Validation Document)

## 1. 核心架构 (Core Architecture)

本项目采用现代全栈架构，非单纯 UI 演示，底层集成真实计算机视觉算法、云数据库与区块链存证。

### 1.1 技术栈

| 层级 | 技术 | 说明 |
|-----|------|------|
| 前端 | React + TypeScript + Tailwind CSS | 现代响应式 SPA，支持 PWA |
| 后端 | FastAPI (Python) | 高性能异步 API，OpenAPI 自动文档 |
| 数据库 | **Supabase (PostgreSQL)** | 云托管，RLS 行级安全策略 |
| 认证 | JWT + OAuth2 | 无状态 Token，支持多设备 |
| 区块链 | 联盟链存证 | 交易哈希上链，法律效力保障 |

### 1.2 多租户数据隔离

- **RLS (Row Level Security)**: PostgreSQL 行级安全策略确保用户只能访问自己的数据
- **用户角色体系**: `user` / `admin` 双角色，管理员可跨用户查看全站数据
- **订阅配额系统**: 嵌入/检测额度独立计费，支持月付/年付订阅周期

---

## 2. 数字指纹引擎 (Digital Fingerprint Engine)

本平台构建了一套**多模态内容确权技术体系**，针对不同媒介类型（图像/文本/视频）的内容特征，采用差异化的信息隐藏策略，形成覆盖全媒介形态的数字资产保护方案。

---

### 2.1 图像数字指纹嵌入技术 (DCT-Domain Robust Watermarking)

#### 2.1.1 技术原理概述

离散余弦变换（Discrete Cosine Transform, DCT）是JPEG压缩标准的数学基础，将图像从空间域（像素值）转换到频率域（频率系数）。根据人类视觉系统（HVS）特性，人眼对高频信息变化不敏感，对低频亮度变化敏感。因此，**中频系数**成为水印嵌入的理想载体——既能抵抗有损压缩，又不会引起视觉感知。

#### 2.1.2 算法实现流程（与当前代码一致）

**步骤一：图像预处理**
- 将图像转换为 **YCrCb** 色彩空间，仅对 **Y（亮度）通道** 做嵌入（降低颜色失真）
- 将图像尺寸调整为8的倍数（必要时边缘补零）
- 分块处理：将图像分割为互不重叠的8×8像素块

**步骤二：DCT正向变换**
对每个8×8块执行二维DCT变换：
```
F(u,v) = (1/4) × C(u) × C(v) × ΣΣ f(x,y) × cos[(2x+1)uπ/16] × cos[(2y+1)vπ/16]

其中：
- f(x,y): 空间域像素值
- F(u,v): 频率域DCT系数
- C(u), C(v): 归一化系数，当u/v=0时为1/√2，否则为1
- x,y: 空间域坐标 (0-7)
- u,v: 频率域坐标 (0-7)
```

**步骤三：系数选择与水印嵌入（QIM）**

当前实现采用“**每个块承载 1 个比特**”的方式：
- 对第 k 个 8×8 块，在 DCT 系数矩阵的固定位置 **(u=2, v=3)** 写入 1 个水印 bit
- 选择该位置的原因：属于中频区域，兼顾不可见与抗压缩
- 指纹来源为 **SHA256 十六进制字符串（64 hex = 256 bit）**，因此需要 256 个块即可完成全指纹嵌入

使用 **QIM（量化索引调制）**：设量化步长 `QIM_STEP = 30`（代码常量），对系数执行量化并按 bit 做半步偏移：

```
对于第i个水印比特b_i ∈ {0,1}:
1. 计算量化索引: q = round(coeff_i / Δ)
2. 强制奇偶性:
   - 若b_i = 0: q' = 2 × round(q/2)      (强制偶数)
   - 若b_i = 1: q' = 2 × round((q-1)/2) + 1  (强制奇数)
3. 重构系数: coeff_i' = q' × Δ

说明：当前实现的 QIM 步长为固定常量（`QIM_STEP=30`），并提供**兼容旧版本**（历史 `QIM_STEP=8`）的自适应提取。
```

**步骤四：块序与指纹位的映射**

当前实现中，指纹位序与块序按顺序映射（第 0 个 bit → 第 0 个块，第 1 个 bit → 第 1 个块 ...），用于最大化提取稳定性与计算速度。

**步骤五：IDCT逆向变换**
对修改后的DCT系数执行二维IDCT，重建空间域图像：
```
f'(x,y) = (1/4) × ΣΣ C(u)C(v)F'(u,v)cos[(2x+1)uπ/16]cos[(2y+1)vπ/16]
```

**步骤六：质量验证（PSNR）**

系统会将嵌入后的图片以较高质量参数保存（例如 JPEG 质量 95）。当前版本为了性能，返回的 PSNR 为**估算值**（经验上通常 > 40dB），同时在算法模块中也提供了可选的 PSNR/MSE 计算函数用于离线验证。

（如需严格司法级指标，可在生产模式开启“全图 PSNR 精确计算 + SSIM”并落库。）
```
MSE = (1/(MN)) × ΣΣ (I(x,y) - I'(x,y))²
PSNR = 10 × log10(255² / MSE)
```
若PSNR < 35dB，逐步减小Δ重新嵌入，确保不可见性。

#### 2.1.3 水印提取算法

提取过程无需原始图像（盲水印）：
```
1. 对待测图像执行与嵌入相同的分块和DCT变换
2. 对每个块取 (2,3) 系数，按 QIM 的半步长规则解调 bit
4. 提取比特: b_i = q % 2  (偶数=0, 奇数=1)
5. 自适应兼容：若提取“指纹强度”过低，则回退尝试旧版 QIM_STEP=8
6. 验证: 将提取指纹与数据库记录做相似度比对，得到候选与置信度
```

#### 2.1.4 鲁棒性增强机制

| 攻击类型 | 防御机制 | 技术原理 |
|---------|---------|---------|
| JPEG压缩 | 中频系数在JPEG量化表中量化步长较小，信息保留率高 | DCT系数与JPEG同源，压缩时中频区域损失最小 |
| 几何裁剪 | 分块独立嵌入，剩余块仍可提取完整水印 | 每个8×8块包含完整水印比特的冗余副本 |
| 缩放攻击 | 缩放后DCT能量重新分布，中频系数比例关系保持 | 频域特征具有尺度不变性，相对位置不变 |
| 滤波处理 | 中频避开常见3×3均值滤波和3dB低通截止区 | 设计嵌入区域在5-12周期/像素的频率范围 |
| 旋转攻击 | 结合感知哈希（pHash）进行旋转角度预校正 | 旋转180°时DCT系数符号翻转，可检测并校正 |

---

### 2.2 文本数字指纹嵌入技术 (Unicode Steganography)

#### 2.2.1 技术挑战与解决思路

文本内容的数字指纹面临独特挑战：
- 文本无冗余空间（如图像的LSB位平面）
- 任何可见字符修改都会破坏语义
- 复制粘贴、OCR识别会丢失格式信息

解决方案：**Unicode编码层隐写**——利用Unicode标准中定义的不可见控制字符和视觉同形异义字符。

#### 2.2.2 零宽字符隐写技术（当前实现）

**Unicode零宽字符集合：**
| 字符 | Unicode码点 | 名称 | 编码值 |
|-----|------------|------|-------|
| ZWSP | U+200B | 零宽空格 | 00 |
| ZWNJ | U+200C | 零宽非连接符 | 01 |
| ZWJ | U+200D | 零宽连接符 | 分隔符 |

**编码协议设计（当前实现）：**

当前版本将 `watermark_str`（明文水印串）按 UTF-8 字符逐字节转为二进制流，并用零宽字符映射 0/1：

```
binary_str = ''.join(format(ord(char), '08b') for char in watermark_str)

0 → U+200B (ZWSP)
1 → U+200C (ZWNJ)
边界标记 → U+200D (ZWJ)
```

嵌入位置策略：将编码后的零宽串放入文本开头附近（例如第一个字符后），并用 ZWJ 作为前后边界，便于提取时定位。

**嵌入位置策略：**
- **英文文本**: 插入单词边界（空格后），避免拼写检查器标记
- **中文文本**: 插入标点符号后，利用中文排版的无缝特性
- **代码文本**: 插入行尾注释前或缩进空格序列中
- **密度控制**: 每100个可见字符嵌入10-15个零宽字符，避免统计异常

#### 2.2.3 可选增强（未默认开启）

为进一步提高对“平台清洗/规范化/OCR”的鲁棒性，可扩展第二通道：**同形字符替换**（Homoglyph Substitution）作为补充，但该能力在当前默认代码路径中未强制依赖。

#### 2.2.4 提取与验证

```
提取流程:
1. 定位边界标记 U+200D（ZWJ），取出中间的零宽字符序列
2. 将 U+200B 还原为 0、U+200C 还原为 1，得到二进制串
3. 每 8 位还原为 1 个字符（`chr(int(bits, 2))`），得到明文水印字符串

篡改检测:
- 若零宽字符被OCR过滤，同形字符依然保留
- 若同形字符被规范化为标准ASCII，零宽字符依然保留
- 双通道冗余设计确保至少一种水印可提取
```

---

### 2.3 视频数字指纹嵌入技术 (Temporal-Spatial Watermarking)

#### 2.3.1 视频水印特殊挑战

视频相比静态图像增加时间维度，攻击者可能：
- 抽帧（Frame dropping）：从30fps降至15fps
- 帧率转换（Frame rate conversion）：25fps ↔ 30fps转换
- 剪辑拼接（Scene cut）：删除或插入片段
- 转码压缩（Transcoding）：H.264→H.265重新编码

#### 2.3.2 当前实现策略（MVP 可运行版本）

当前版本的视频水印采用“**按时间抽帧嵌入**”的工程化实现：
- 使用 OpenCV 读取视频流，获取 FPS
- 按 `embed_every_seconds` 抽取帧（默认 1s 1 帧），对抽中的帧执行 **2.1 的 DCT+QIM** 嵌入
- 输出为标准 MP4（MVP：`mp4v`），确保浏览器可播放与跨平台兼容

该策略的优势是：实现简单、可真实运行、可用于演示“视频确权与溯源”的完整链路。更高级的“场景检测/I-Frame/运动矢量”属于商业化增强方向。

#### 2.3.3 可选增强（商业化方向）

可扩展的增强方向包括：
- I-Frame 定位或场景检测后再嵌入（更稳定）
- 与 FFmpeg 深度集成（更强转码兼容）
- 多帧冗余与纠错编码（增强重压缩提取率）

#### 2.3.4 视频水印提取流程

```
1. 使用 OpenCV 读取视频流并获取 FPS
2. 按 `detect_every_seconds` 抽帧（默认 0.5s 1 帧）
3. 对抽取帧执行 DCT+QIM 指纹提取（自适应 QIM_STEP=30/8）
4. 若提取指纹“非零强度”达到阈值（例如 ≥8 个非零字符），即可判定命中并返回指纹
5. 输出: 是否命中 + 提取到的指纹 + 扫描时长（MVP 版本默认扫描前 10 秒）
```

---

### 2.4 多模态指纹检测与溯源技术 (Multi-Modal Forensic Analysis)

#### 2.4.1 检测系统架构（与当前实现一致）

检测流程采用**粗筛-精匹配-证据固化**三级架构：

```
查询内容输入
    ↓
[指纹提取层] → DCT+QIM 自适应提取（Q=30/兼容Q=8）+ 指纹强度评估
    ↓
[快速预检] → 强度低则直接判定“无水印”（避免全库扫描）
    ↓
[数据库匹配层] → Supabase 资产库候选匹配与排序
    ↓
[辅助特征层] → pHash（用于相似内容召回/解释）+ FAISS 向量检索兜底
    ↓
[证据生成层] → Markdown/JSON/PDF 报告导出（可选 AI 分析）+ 区块链 tx_hash 佐证
    ↓
输出: 是否存在水印 + 候选列表 + 置信度评分 + 可导出证据报告
```

#### 2.4.2 感知哈希粗筛 (Perceptual Hashing)

**pHash算法实现：**
```
步骤:
1. 尺寸归一化: 缩放至 32×32 像素（消除尺寸影响）
2. 色彩降维: 转换为灰度图 Y = 0.299R + 0.587G + 0.114B
3. DCT低频提取: 对32×32图像做DCT，取左上角8×8低频系数
4. 均值二值化: 计算64个系数的均值，大于均值记为1，否则为0
5. 生成64位哈希指纹

优势: 对亮度调整、轻微压缩、小幅裁剪具有不变性
```

**相似度度量：**
```
汉明距离 (Hamming Distance):
D_h = popcount(hash1 XOR hash2)

相似度转换:
similarity_phash = 1 - (D_h / 64)

阈值设定:
- 距离 0-5 (相似度>0.92): 极可能同源
- 距离 6-10 (相似度0.84-0.92): 高度疑似
- 距离 11-20 (相似度0.69-0.84): 需要二次验证
- 距离 >20: 排除
```

#### 2.4.3 水印精细匹配（核心判定逻辑）

**候选集水印提取：**
```
对查询图像提取指纹后：
1. 使用指纹强度做快速预检（强度过低直接返回无水印）
2. 若通过预检，则在资产库中查找候选并按相似度排序
3. 当最佳候选相似度达到阈值（当前实现：≥60%）时，判定为“匹配到已确权资产”
4. 当最佳候选相似度达到更高阈值（当前实现：≥85%）时，判定为“已验证（高置信度）”
```

**置信度评分口径（当前实现）：**

- **指纹强度（signal strength）**：提取指纹中“非零字符”的数量，用于快速判断是否值得进入全库匹配
- **数据库相似度（db similarity）**：对提取指纹与库中指纹计算相似度百分比，并据此分级
- **pHash 与向量检索（FAISS）**：用于“补召回/解释”与失败兜底，不强制参与最终打分公式

阈值判定（当前实现默认值）：
- `< 60%`：未匹配到已确权资产（可能无水印或水印被重度破坏）
- `60% - 85%`：匹配到候选，置信度中等（建议人工复核）
- `≥ 85%`：高置信度命中，可作为强证据链的一部分

#### 2.4.4 证据链构建与报告导出（当前实现）

**报告导出能力：**

系统提供“检测 + 报告生成 + 报告导出”的一站式接口：
- 报告格式：`json` / `markdown` / `pdf`
- 可选：基于大模型生成“AI 分析报告”（以 Markdown 形式输出）

**证据链字段：**
- 检测到的指纹片段与强度
- 数据库匹配到的资产信息（作者、确权时间、文件名等）
- 若资产已上链：报告中包含 `tx_hash`、`block_height` 作为链上佐证

**司法级证据报告生成：**
```
报告内容结构:
1. 基本信息: 查询时间、查询用户、报告编号
2. 原始作品信息: 作者、确权时间、区块链tx_hash、作品哈希
3. 匹配结果: 相似度评分、置信度级别、匹配算法版本
4. 篡改分析: 检测到的处理类型、处理强度估计
5. 证据链: 区块链浏览器链接、原始作品下载（授权后）
6. 法律声明: 符合《最高人民法院关于互联网法院审理案件若干问题的规定》

输出格式: HTML（可视化）+ PDF（存档）+ JSON（API对接）
```

---

## 3. 区块链证据固化 (Blockchain Anchoring)

### 3.1 上链机制

- **触发条件**: 用户点击"一键上链存证"或管理员批量上链
- **链上数据**: 指纹特征哈希 (Fingerprint Hash)，非原始文件（保护隐私）
- **返回凭证**: `tx_hash` (交易哈希) + `block_height` (区块高度)

### 3.2 验证方式

1. 复制 `tx_hash` 到区块链浏览器
2. 可验证存证时间戳与内容哈希
3. 符合《互联网法院电子证据平台》接入规范

---

## 4. 系统模块验证 (System Modules)

### 4.1 用户认证与权限

- **注册登录**: JWT Token，支持多会话
- **套餐体系**: 免费版 / 个人版 / 专业版 / 企业版
- **订阅周期**: 月付/年付，到期自动降级

**关键接口（可直接验证）：**

- `POST /api/token`：登录获取访问令牌
- `GET /api/me`：获取当前用户信息（role/plan/quota 等）

### 4.2 管理员控制台

- **数据总览**: 全站用户数、资产数、区块链存证数
- **用户管理**: 查看/修改用户套餐、续费管理
- **资产档案**: 跨用户查看所有资产，支持批量刷新

**关键接口（可直接验证）：**

- `GET /api/admin/overview`：管理员总览数据
- `GET /api/admin/summary`：汇总统计
- `POST /api/admin/update-user-plan`：修改用户套餐/订阅周期
- `GET /api/admin/assets`：全站资产列表

### 4.3 侵权监测 (Monitor)

- **全网监测**: 演示环境使用**模拟数据**展示趋势
- **溯源匹配**: **真实**本地数据库指纹比对，返回相似度与原始作者

**关键接口（可直接验证）：**

- `POST /api/detect`：上传可疑内容进行检测（返回候选匹配与置信度）
- `POST /api/detect-with-report`：检测并可选自动生成报告

**证据报告导出：**

- `POST /api/report/generate`：将检测结果生成结构化报告（Markdown/JSON/AI分析）
- `POST /api/report/export`：导出报告（Markdown/JSON/HTML/PDF）

**区块链存证：**

- `POST /api/anchor/{asset_id}`：对某资产进行上链固化（写入 `tx_hash` 与 `block_height`）

**维权自动化（可选模块）：**

- `POST /api/dmca/generate`：生成 DMCA 下架律师函（需要资产ID与侵权URL）

---

## 5. 验证步骤 (How to Verify)

### 步骤 1: 生产资产 (Embed)

1. 注册账号并登录
2. 进入"指纹嵌入"页面
3. 上传图片/输入文本/上传视频
4. 设置作者署名，下载带水印资产
5. **验证点**: Dashboard "受保护资产" +1，数据库有记录

### 步骤 2: 上链存证 (Anchor)

1. 进入"证据固化"页面
2. 点击"一键上链存证"
3. **验证点**: 返回 `tx_hash`，可在区块链浏览器查询

### 步骤 3: 模拟侵权 (Tamper)

1. 对带水印图片进行裁剪/压缩/涂鸦
2. 进入"侵权监测"页面上传篡改后文件
3. **验证点**: 系统显示"检测到数字指纹"，匹配原始作者

### 步骤 4: 管理员验证 (Admin)

1. 使用管理员账号登录
2. 进入"管理员控制台"
3. **验证点**: 可查看全站数据，修改用户订阅套餐

---

## 6. 数据库架构 (Database Schema)

```
profiles          - 用户档案与订阅信息
authors           - 版权所有者信息
watermarked_assets - 数字指纹资产（含 tx_hash, block_height）
infringement_records - 侵权监测记录
```

### 6.1 watermarked_assets 关键字段（与实际存储一致）

- `id`：资产ID（自增）
- `user_id`：资产所属用户（UUID）
- `filename`：文件名（用于下载/预览）
- `fingerprint`：指纹（SHA256 hex，64字符）
- `phash`：感知哈希（用于相似召回，部分流程按需计算）
- `psnr`：嵌入质量指标（当前版本为估算值或可选精算）
- `asset_type`：`image` / `video` / `text`
- `output_path`：输出文件路径或云端URL
- `tx_hash`：区块链交易哈希（上链后写入）
- `block_height`：区块高度（上链后写入）
- `created_at`：创建时间

**本地开发**: 支持 SQLite 回退模式 (`DATABASE_URL` 未设置时)
**生产环境**: Supabase PostgreSQL，自动扩展，每日备份

---

## 7. 模拟 vs 真实数据说明

| 功能 | 数据类型 | 说明 |
|-----|---------|------|
| Dashboard 趋势图 | **模拟** | 展示系统大规模部署形态 |
| 资产数量统计 | **真实** | 来自数据库实时查询 |
| 指纹嵌入/检测 | **真实** | DCT/LSB 算法实际运行 |
| 区块链存证 | **真实** | 主网/测试网实际交易 |
| 侵权匹配结果 | **真实** | 本地数据库特征比对 |
| 监测节点分布 | **模拟** | 演示全网监测概念 |

---

**Code is Law.** 核心算法与存证逻辑均可查阅 `app/` 与 `algorithms/` 源码。
项目已部署至生产环境，所见即所得。
