# AIGCGuard 运维部署完全指南

> 本文档记录 2025年2月25日 完成的完整部署流程与配置，包含：
> - 部署架构（GitHub + Render + Vercel + 阿里云 DNS）
> - 邮箱验证修复（解决国内 supabase.co 无法访问问题）
> - UptimeRobot 监控配置
> - 后续更新流程
> - 其他智能体协作指南

**当前稳定域名：**
- **前端**：`https://aigcguard.zsypioneer.cn`
- **后端**：`https://api.aigcguard.zsypioneer.cn`

---

## 一、部署架构总览

```
GitHub (main分支)
    │
    ├─→ Render (Docker) → api.aigcguard.zsypioneer.cn
    │   - FastAPI 后端
    │   - 健康检查: /health
    │   - 邮箱验证代理: /api/verify
    │
    └─→ Vercel (Vite+React) → aigcguard.zsypioneer.cn
        - SPA 应用
        - 邮箱验证回调: /auth/callback
        - API 代理: /api/* → Render
```

---

## 二、各平台配置详情

### 2.1 GitHub 代码仓库
- **分支**：`main`
- **自动触发**：推送到 `main` 自动触发 Render 和 Vercel 重新部署
- **关键文件**：
  - `vercel.json`（根目录 + web_app/ 各一份）
  - `Dockerfile`（Render 部署用）

### 2.2 Render 后端配置

**服务类型**：Web Service（Docker）

**环境变量**（必须配置）：
| 变量名 | 值 | 说明 |
|--------|-----|------|
| `SUPABASE_URL` | `https://xxx.supabase.co` | Supabase 项目 URL |
| `SUPABASE_KEY` | `eyJxxx` | Supabase Anon Key |
| `SUPABASE_SERVICE_ROLE_KEY` | `eyJxxx` | Supabase Service Role Key |
| `BACKEND_CORS_ORIGINS` | `https://aigcguard.zsypioneer.cn,http://localhost:5173` | 允许的前端域名 |
| `BACKEND_CORS_ORIGIN_REGEX` | `^https://.*\.vercel\.app$` | 正则兜底，放行 Vercel 预览域名 |

**关键端点**：
- `GET /health` - 健康检查（返回 `healthy`）
- `HEAD /health` - 健康检查（UptimeRobot 用，返回 200）
- `GET /api/verify` - 邮箱验证代理（转发到 Supabase）

### 2.3 Vercel 前端配置

**构建设置**：
- **Root Directory**：`web_app`（重要！）
- **Build Command**：`npm run build`
- **Output Directory**：`dist`

**环境变量**：
| 变量名 | 值 |
|--------|-----|
| `VITE_API_URL` | `https://api.aigcguard.zsypioneer.cn/api` |

**vercel.json 配置**（根目录和 web_app/ 都要有）：
```json
{
  "rewrites": [
    { "source": "/api/health", "destination": "https://api.aigcguard.zsypioneer.cn/health" },
    { "source": "/api/(.*)", "destination": "https://api.aigcguard.zsypioneer.cn/api/$1" },
    { "source": "/(.*)", "destination": "/index.html" }
  ]
}
```

### 2.4 阿里云 DNS 配置

**前端域名** `aigcguard.zsypioneer.cn`：
- 类型：CNAME
- 主机记录：`aigcguard`
- 记录值：Vercel 提供的 target（如 `cname.vercel-dns.com` 或专属字符串）

**后端域名** `api.aigcguard.zsypioneer.cn`：
- 类型：CNAME
- 主机记录：`api.aigcguard`（注意不是 `api`）
- 记录值：`aigcguard.onrender.com`（或 Render 提供的 target）

---

## 三、邮箱验证修复（核心修复）

### 3.1 问题背景
- Supabase 邮箱验证链接指向 `xxx.supabase.co/auth/v1/verify`
- 国内网络无法直接访问 `*.supabase.co`
- 导致用户注册后无法完成邮箱验证

### 3.2 解决方案

**方案：后端代理 + 自定义域名回调**

1. **后端代理端点**（`app/api/endpoints/auth.py`）：
   ```python
   @router.get("/verify")
   async def proxy_supabase_verify(request: Request):
       """代理 Supabase 邮箱验证，避免用户直接访问 supabase.co"""
       verify_url = settings.SUPABASE_URL.rstrip("/") + "/auth/v1/verify"
       params = dict(request.query_params)
       headers = {"apikey": settings.SUPABASE_KEY, "Authorization": f"Bearer {settings.SUPABASE_KEY}"}
       async with httpx.AsyncClient(follow_redirects=False) as client:
           resp = await client.get(verify_url, params=params, headers=headers)
       location = resp.headers.get("location")
       if location:
           return RedirectResponse(url=location, status_code=302)
       raise HTTPException(status_code=resp.status_code, detail=resp.text)
   ```

2. **前端回调页面**（`web_app/src/pages/AuthCallback.tsx`）：
   - 处理 `/auth/callback` 路由
   - 解析 URL 参数中的 `code` 或 `access_token`/`refresh_token`
   - 调用 `supabase.auth.exchangeCodeForSession()` 或 `supabase.auth.setSession()`
   - 完成后跳转到登录页

3. **注册/重发邮件时设置 redirect URL**：
   ```typescript
   // web_app/src/services/api.ts
   await supabase.auth.signUp({
       email, password,
       options: {
           emailRedirectTo: `${window.location.origin}/auth/callback`
       }
   });
   ```

4. **Supabase 邮件模板修改**：
   - 进入 Supabase Dashboard → Authentication → Email Templates
   - 找到 "Confirm signup" 模板
   - 修改链接为：`https://api.aigcguard.zsypioneer.cn/api/verify?token={{ .Token }}&type=signup&redirect_to=https://aigcguard.zsypioneer.cn/auth/callback`

### 3.3 验证流程
1. 用户注册 → 收到邮件 → 点击链接
2. 链接访问 `api.aigcguard.zsypioneer.cn/api/verify`（国内可访问）
3. 后端代理请求到 Supabase 完成验证
4. 跳转回 `aigcguard.zsypioneer.cn/auth/callback`
5. 前端完成 session 设置，跳转到登录页

---

## 四、UptimeRobot 监控配置

### 4.1 用途
- Render Free 实例 15 分钟无访问会休眠
- UptimeRobot 定时 ping `/health`，保持实例活跃

### 4.2 配置步骤
1. 注册/登录 [UptimeRobot](https://uptimerobot.com)
2. 点击 **Add New Monitor**
3. 配置参数：
   - **Monitor Type**: HTTP(s)
   - **Friendly Name**: `aigcguard-backend-health`
   - **URL**: `https://api.aigcguard.zsypioneer.cn/health`
   - **Monitoring Interval**: 5 minutes
4. 保存后等待状态变 **Up（绿色）**

### 4.3 注意事项
- 后端已同时支持 `GET /health` 和 `HEAD /health`
- 如果显示 Down/405，检查 Render 是否已部署最新代码

---

## 五、后续更新流程

### 5.1 日常代码更新
```bash
# 本地修改代码
# ... 修改代码 ...

git add .
git commit -m "描述修改内容"
git push origin main
```

推送后自动触发：
- Render 重新部署后端（约 2-5 分钟）
- Vercel 重新构建前端（约 1-2 分钟）

### 5.2 验证部署成功
1. **Render**：查看 Deployments 页面，确认 commit 哈希匹配
2. **Vercel**：查看 Deployments 页面，确认状态为 "Ready"
3. **健康检查**：访问 `https://api.aigcguard.zsypioneer.cn/health` 返回 `healthy`
4. **前端验证**：访问 `https://aigcguard.zsypioneer.cn` 页面正常

### 5.3 环境变量更新
- 如需修改环境变量，在 Render/Vercel Dashboard 中修改
- 修改后通常需要重新部署（或自动触发）

---

## 六、与其他智能体协作指南

### 6.1 交接时必须提供的信息
当让其他智能体协助维护/更新项目时，务必提供：

1. **部署架构图**（见第一节）
2. **当前域名**：
   - 前端：`https://aigcguard.zsypioneer.cn`
   - 后端：`https://api.aigcguard.zsypioneer.cn`
3. **Vercel Root Directory**：`web_app`（非根目录）
4. **关键环境变量**：`VITE_API_URL`、`BACKEND_CORS_ORIGINS` 等

### 6.2 常见修改注意事项

| 修改类型 | 注意事项 |
|----------|----------|
| **新增 API 端点** | 确保在 `app/main.py` 注册路由，Vercel 代理规则自动生效 |
| **修改邮箱验证逻辑** | 不要修改 Supabase 邮件模板 URL，保持使用 `/api/verify` 代理 |
| **修改前端路由** | SPA 路由已在 `vercel.json` 配置 fallback，新增页面无需额外配置 |
| **修改 CORS** | 如需新增允许域名，修改 Render 的 `BACKEND_CORS_ORIGINS` 环境变量 |

### 6.3 故障排查速查表

**CORS 报错**：
- 检查 `BACKEND_CORS_ORIGINS` 是否包含当前前端域名
- 检查 `BACKEND_CORS_ORIGIN_REGEX` 是否启用

**Vercel 404**：
- 检查 `vercel.json` 是否存在（根目录和 `web_app/` 都要有）
- 检查是否配置了 `/api/*` 代理规则

**邮箱验证失败**：
- 检查邮件模板链接是否使用 `api.aigcguard.zsypioneer.cn/api/verify`
- 检查 `/auth/callback` 页面是否正常

**Render 休眠**：
- 检查 UptimeRobot 监控状态是否为 Up
- 手动访问 `/health` 唤醒服务

---

## 七、关键文件清单

### 7.1 部署相关文件
| 文件 | 作用 |
|------|------|
| `vercel.json` | Vercel 路由代理 + SPA fallback |
| `web_app/vercel.json` | Vercel 路由代理（当 Root Directory 为 web_app 时使用） |
| `Dockerfile` | Render Docker 部署配置 |
| `app/main.py` | 后端入口，包含 `/health` 和 `/api/verify` 端点 |
| `web_app/src/pages/AuthCallback.tsx` | 邮箱验证回调页面 |
| `web_app/src/services/api.ts` | 注册时设置 `emailRedirectTo` |

### 7.2 现有文档
| 文档 | 内容 |
|------|------|
| `README.md` | 项目简介 |
| `PROJECT_OVERVIEW.md` | 项目架构概览 |
| `TECHNICAL_VALIDATION.md` | 技术验证细节 |
| `Vercel+Supabase+Render部署方案.md` | 部署方案说明 |
| `UptimeRobot配置指南.md` | UptimeRobot 配置 |
| `部署后更新维护指南.md` | 维护指南 |
| **本文档** | 完整运维部署指南（汇总版） |

---

## 八、快速验证命令

### 8.1 后端健康检查
```bash
curl https://api.aigcguard.zsypioneer.cn/health
# 期望返回: {"status": "healthy", ...}
```

### 8.2 前端 SPA 路由
```bash
curl https://aigcguard.zsypioneer.cn/login
# 应返回 index.html 内容（不是 404）
```

### 8.3 API 代理
```bash
curl https://aigcguard.zsypioneer.cn/api/health
# 应返回后端 health 接口内容（通过 Vercel 代理）
```

---

## 九、联系方式与备注

- **GitHub 仓库**：`zsy-dream/aigcguard`
- **Render 服务名**：`aigcguard`
- **Vercel 项目名**：`aigcguard`
- **Supabase 项目**：通过 Dashboard 管理

**重要提醒**：
- 修改生产配置前，先在本地测试
- 每次 `git push` 都会触发自动部署，确保代码可构建
- 如遇到 405/404 错误，先检查 Render/Vercel 部署状态

---

*本文档最后更新：2025年2月25日*
*维护者：Cascade AI*
