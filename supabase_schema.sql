-- ==========================================
-- SnapGuard AIGC (æ™ºå¾¡Â·çž¬æ¯) Supabase åˆå§‹åŒ–è„šæœ¬
-- ==========================================

-- 1. åˆ›å»º profiles è¡¨ï¼Œä¸Ž Supabase å†…ç½®çš„ auth.users è”åŠ¨ç»‘å®š
CREATE TABLE public.profiles (
  id UUID REFERENCES auth.users ON DELETE CASCADE PRIMARY KEY, -- å¯¹åº”åŽŸ users è¡¨ï¼Œå¹¶ç»‘å®šå†…ç½®ç”¨æˆ·
  username TEXT UNIQUE NOT NULL,
  role TEXT DEFAULT 'user',
  display_name TEXT,
  plan TEXT DEFAULT 'free',
  -- å…¼å®¹æ—§å­—æ®µï¼ˆé€æ­¥è¿ç§»ï¼‰
  quota_used INTEGER DEFAULT 0,
  quota_total INTEGER DEFAULT 10,
  -- æ–°é¢åº¦ä½“ç³»ï¼šåˆ†åˆ«é™åˆ¶åµŒå…¥å’Œæ£€æµ‹
  quota_embed_used INTEGER DEFAULT 0,
  quota_embed_total INTEGER DEFAULT 50,    -- å…è´¹ç‰ˆé»˜è®¤50æ¬¡åµŒå…¥
  quota_detect_used INTEGER DEFAULT 0,
  quota_detect_total INTEGER DEFAULT 20,   -- å…è´¹ç‰ˆé»˜è®¤20æ¬¡æ£€æµ‹
  -- è®¢é˜…å‘¨æœŸä½“ç³»
  subscription_period TEXT DEFAULT NULL,  -- 'month' æœˆä»˜ / 'year' å¹´ä»˜
  subscription_expires_at TIMESTAMP WITH TIME ZONE DEFAULT NULL,  -- è®¢é˜…åˆ°æœŸæ—¶é—´
  subscription_status TEXT DEFAULT 'inactive',  -- 'active'/'expired'/'cancelled'/'inactive'
  subscription_started_at TIMESTAMP WITH TIME ZONE DEFAULT NULL,  -- è®¢é˜…å¼€å§‹æ—¶é—´
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

-- 2. åˆ›å»º authors è¡¨ (ç‰ˆæƒæ‰€æœ‰è€…ä¿¡æ¯)
CREATE TABLE public.authors (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  user_id UUID REFERENCES auth.users ON DELETE CASCADE UNIQUE NOT NULL,
  author_name TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

-- 3. åˆ›å»º watermarked_assets è¡¨ (æ•°å­—æŒ‡çº¹èµ„äº§)
CREATE TABLE public.watermarked_assets (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_id UUID REFERENCES auth.users ON DELETE CASCADE NOT NULL,
  filename TEXT NOT NULL,
  fingerprint TEXT NOT NULL,
  phash TEXT,
  output_path TEXT,
  input_path TEXT,
  timestamp TEXT NOT NULL,
  psnr REAL,
  tx_hash TEXT DEFAULT NULL,
  block_height INTEGER DEFAULT NULL,
  asset_type TEXT DEFAULT 'image',
  created_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

-- 4. åˆ›å»º infringement_records è¡¨ (ä¾µæƒç›‘æµ‹è®°å½•)
CREATE TABLE public.infringement_records (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  asset_id BIGINT REFERENCES public.watermarked_assets(id) ON DELETE CASCADE,
  source_url TEXT,
  similarity REAL,
  matched_user_id UUID,
  detected_at TIMESTAMP WITH TIME ZONE DEFAULT TIMEZONE('utc'::text, NOW()) NOT NULL
);

-- ==========================================
-- ðŸ’¡ ä»¥ä¸‹å¼€å¯ Supabase RLS (è¡Œçº§å®‰å…¨ç­–ç•¥) ä¿æŠ¤æ•°æ®å®‰å…¨
-- ==========================================

ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.authors ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.watermarked_assets ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.infringement_records ENABLE ROW LEVEL SECURITY;

-- åªæœ‰è‡ªå·±å¯ä»¥è¯»å–å’Œæ›´æ–°è‡ªå·±çš„ profiles
CREATE POLICY "Users can view own profile" ON public.profiles FOR SELECT USING ( auth.uid() = id );
CREATE POLICY "Users can update own profile" ON public.profiles FOR UPDATE USING ( auth.uid() = id );

-- Assetsçš„ç­–ç•¥: åªèƒ½æŸ¥çœ‹è‡ªå·±çš„ä½œå“
CREATE POLICY "Users can view own assets" ON public.watermarked_assets FOR SELECT USING ( auth.uid() = user_id );

-- ä¾µæƒè®°å½•çš„ç­–ç•¥: åªèƒ½æŸ¥çœ‹å±žäºŽè‡ªå·±èµ„äº§çš„ä¾µæƒ
CREATE POLICY "Users can view own infringement records" ON public.infringement_records 
FOR SELECT USING ( 
  asset_id IN (SELECT id FROM public.watermarked_assets WHERE user_id = auth.uid()) 
);

-- ==========================================
-- ðŸ”” å¼€å¯ Realtime å®žæ—¶è®¢é˜… (é‡è¦ï¼šä¸ºäº†è®©å‰ç«¯çž¬é—´æ”¶åˆ°æŠ¥è­¦)
-- ==========================================
-- é…ç½® publication ä»¥æ”¯æŒ Realtime
begin;
  drop publication if exists supabase_realtime;
  create publication supabase_realtime;
commit;
alter publication supabase_realtime add table public.infringement_records;
alter publication supabase_realtime add table public.watermarked_assets;

-- ==========================================
-- ðŸš€ è§¦å‘å™¨: å½“ç”¨æˆ·æ³¨å†Œæ—¶ï¼Œè‡ªåŠ¨ç”Ÿæˆ profile å’Œ author è®°å½•
-- ==========================================
CREATE OR REPLACE FUNCTION public.handle_new_user() 
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, username, display_name)
  VALUES (new.id, new.email, new.raw_user_meta_data->>'display_name');

  INSERT INTO public.authors (user_id, author_name)
  VALUES (new.id, new.raw_user_meta_data->>'display_name');
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE public.handle_new_user();

UPDATE public.profiles
SET 
  role = 'admin',
  plan = 'enterprise',
  quota_total = 9999999,
  display_name = 'ZSY Pioneer'
WHERE username = 'zsypioneer@snapguard.com';

